---
title: "p8105_hw2_bx2232"
output: github_document
---
```{r}
library(tidyverse)
library(lubridate)
library(readxl)
library(haven)
library(janitor)
```

```{r}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```
#Problem 1
# pols-month
```{r}
pols_df <- read_csv("fivethirtyeight_datasets/pols-month.csv", na = c("NA", ".", "")) %>% 
  janitor::clean_names() %>% 
  separate(mon, into = c("year", "month", "day"), sep = "-") %>% 
  mutate(
    year = as.integer(year),
    month = factor(month.name[as.integer(month)],
                   levels = month.name,
                   ordered = TRUE),
    president = case_when(
      prez_dem == 1 ~ "dem",
      prez_gop == 1 ~ "gop",
      TRUE ~ NA_character_
    )
  ) %>% 
  select(-prez_dem, -prez_gop, -day) %>% 
  select(year, month, everything())

pols_df
```
#snp
```{r}
snp_df <- read_csv("fivethirtyeight_datasets/snp.csv", na = c("NA", ".", "")) %>% 
  janitor::clean_names() %>% 
  separate(date, into = c("year", "month", "day"), sep = "-") %>% 
  mutate(
    year = as.integer(year),
    month = factor(month.name[as.integer(month)],
                   levels = month.name,
                   ordered = TRUE)
  ) %>% 
  select(year, month, close) %>% 
  arrange(year, month)

snp_df

```
#unemployment
```{r}
unemp_df <- read_csv("fivethirtyeight_datasets/unemployment.csv", na = c("NA", ".", "")) %>% 
  janitor::clean_names() %>% 
  pivot_longer(
    cols = -year,
    names_to = "month",
    values_to = "unemployment"
  ) %>% 
  mutate(
    year = as.integer(year),
    month = factor(
      month.name[match(month, tolower(month.abb))],
      levels = month.name,
      ordered = TRUE
    )
  ) %>% 
  arrange(year, month)

unemp_df

```
#join all data together
```{r}
merged_df <- pols_df %>% 
  left_join(snp_df,  by = c("year","month")) %>% 
  left_join(unemp_df, by = c("year","month")) %>% 
  arrange(year, month)

merged_df

```

```{r}
summary(pols_df)
summary(snp_df)
summary(unemp_df)
summary(merged_df)
```

#Problem 2
# Mr. Trash Wheel
```{r}
mr_df <- readxl::read_excel(
  "202509 Trash Wheel Collection Data.xlsx",
  sheet = "Mr. Trash Wheel",
  range = readxl::cell_limits(ul = c(2, 1), lr = c(NA, NA))
) %>% 
  janitor::clean_names() %>% 
  filter(!is.na(dumpster)) %>% 
  mutate(
    date = as.Date(date),
    year = as.integer(lubridate::year(date)),
    month = factor(
      month.name[lubridate::month(date)],
      levels = month.name,
      ordered = TRUE
    ),
    sports_balls = as.integer(round(sports_balls)),
    wheel = "Mr"
  ) %>% 
  select(wheel, dumpster, date, year, month, everything())

mr_df
```
# Professor Trash Wheel
```{r}
prof_df <- readxl::read_excel(
  "202509 Trash Wheel Collection Data.xlsx",
  sheet = "Professor Trash Wheel",
  range = readxl::cell_limits(ul = c(2, 1), lr = c(NA, NA))
) %>%
  janitor::clean_names() %>%
  filter(!is.na(dumpster)) %>%
  mutate(
    date  = as.Date(date),
    year  = as.integer(lubridate::year(date)),
    month = factor(month.name[lubridate::month(date)], levels = month.name, ordered = TRUE),
    wheel = "Professor"
  ) %>%
  select(wheel, dumpster, date, year, month, everything())

prof_df
```

#Gwynns Falls Trash Wheel
```{r}
gwyn_df <- readxl::read_excel(
  "202509 Trash Wheel Collection Data.xlsx",
  sheet = "Gwynns Falls Trash Wheel",
  range = readxl::cell_limits(ul = c(2, 1), lr = c(NA, NA))
) %>% 
  janitor::clean_names() %>% 
  filter(!is.na(dumpster)) %>% 
  mutate(
    date = as.Date(date),
    year = as.integer(lubridate::year(date)),
    month = factor(month.name[lubridate::month(date)], levels = month.name, ordered = TRUE),
    sports_balls = if ("sports_balls" %in% names(.)) as.integer(round(sports_balls)) else NA_integer_,
    wheel = "Gwynns Falls Trash Wheel"
  ) %>% 
  select(wheel, dumpster, date, year, month, everything())

gwyn_df
```
```{r}
trash_df <- dplyr::bind_rows(mr_df, prof_df, gwyn_df) |>
  dplyr::arrange(wheel, date) |>
  dplyr::select(wheel, dumpster, date, year, month, dplyr::everything())

```

```{r}
prof_total_weight <- trash_df |>
  dplyr::filter(wheel == "Professor") |>
  dplyr::summarise(total_weight_tons = sum(weight_tons, na.rm = TRUE)) |>
  dplyr::pull(total_weight_tons)

gwyn_cigs_jun2022 <- trash_df |>
  dplyr::filter(wheel == "Gwynnda", year == 2022, month == "June") |>
  dplyr::summarise(total_cig_butts = sum(cigarette_butts, na.rm = TRUE)) |>
  dplyr::pull(total_cig_butts)

```
The combined Trash Wheel dataset contains `r nrow(trash_df)` observations across
`r length(unique(trash_df$wheel))` wheels (`r paste(sort(unique(trash_df$wheel)), collapse=", ")`).
Key variables include `r paste(intersect(c("dumpster","date","year","month","weight_tons",
"volume_cubic_yards","plastic_bottles","polystyrene","cigarette_butts","sports_balls"),
names(trash_df)), collapse=", ")`. For available data, Professor Trash Wheel has collected a total of
`r round(prof_total_weight, 1)` tons of trash. Gwynnda collected `r gwyn_cigs_jun2022`
cigarette butts in June 2022.

#problem 3
```{r}
zip_map <- read_csv("zillow_data/Zip Codes.csv") %>%
  clean_names() %>%
  mutate(zip_code = as.character(zip_code))

zori_wide <- read_csv("zillow_data/Zip_zori_uc_sfrcondomfr_sm_month_NYC.csv") %>%
  clean_names() %>%
  rename(zip_code = region_name) %>%
  mutate(zip_code = as.character(zip_code))

glimpse(zip_map)
glimpse(zori_wide)

```

```{r}
zori_long <- zori_wide %>%
  pivot_longer(
    cols = starts_with("x20"),
    names_to = "date_str",
    values_to = "rent_index"
  ) %>%
  mutate(
    date_str = gsub("^x", "", date_str),    # remove "x"
    date_str = gsub("_", "-", date_str),    # turn underscores to dashes
    date = ymd(date_str),
    year = year(date),
    month = month(date)                     # numeric month (1 = Jan)
  ) %>%
  select(zip_code, year, month, date, rent_index)

glimpse(zori_long)
```
```{r}
tidy_df <- zori_long %>%
  left_join(zip_map, by = "zip_code")
```

```{r}
list(
  total_observations   = nrow(tidy_df),
  unique_zip_codes     = n_distinct(tidy_df$zip_code),
  unique_neighborhoods = n_distinct(na.omit(tidy_df$neighborhood))
)
```

```{r}
setdiff(zip_map$zip_code, zori_wide$zip_code) %>% head(10)
```

```{r}
tidy_df <- tidy_df %>%
  mutate(rent_index = suppressWarnings(as.numeric(rent_index)))

jan_wide <- tidy_df %>%
  filter(month == 1, year %in% c(2020, 2021)) %>%
  group_by(zip_code, neighborhood, year) %>%
  summarise(rent_index = mean(rent_index, na.rm = TRUE), .groups = "drop") %>%
  tidyr::pivot_wider(
    names_from  = year,
    values_from = rent_index,
    names_prefix = "y"
  ) %>%
  mutate(across(starts_with("y"), ~ suppressWarnings(as.numeric(.)))) %>%
  filter(!is.na(y2020) & !is.na(y2021))

top_drops <- jan_wide %>%
  mutate(diff = y2021 - y2020) %>%
  arrange(diff) %>%
  slice_head(n = 10) %>%
  select(zip_code, neighborhood, diff)

top_drops
```